<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Faba Beans Trial CBA Decision Aid — Newcastle Business School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Cost–benefit decision aid for real faba beans soil amendment trials, comparing every treatment to the measured control." />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="app.js"></script>
</head>
<body>
  <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

  <header class="app-header">
    <div class="branding">
      <div class="logo-circle" aria-hidden="true">NBS</div>
      <div class="title-group">
        <h1>Faba Beans Trial Cost–Benefit Decision Aid</h1>
        <p>
          This tool uses the full faba beans trial dataset to compare every soil treatment
          against the real measured control, using discounted benefits and costs per hectare.
        </p>
      </div>
    </div>
    <div class="header-meta">
      <span class="badge badge-live">Real trial data</span>
      <span class="badge badge-baseline">Control-based comparisons</span>
    </div>
  </header>

  <main class="app-main">
    <nav class="tab-nav" aria-label="Main sections">
      <button class="tab-button active" data-tab="overviewTab">Overview</button>
      <button class="tab-button" data-tab="dataTab">Data and settings</button>
      <button class="tab-button" data-tab="resultsTab">Results</button>
      <button class="tab-button" data-tab="chartsTab">Charts</button>
      <button class="tab-button" data-tab="exportsTab">Exports and AI brief</button>
      <a class="tab-link" href="technical-appendix.html" target="_blank" rel="noopener">
        Technical details (opens in new tab)
      </a>
    </nav>

    <!-- OVERVIEW TAB -->
    <section id="overviewTab" class="tab-panel active" aria-labelledby="Overview">
      <p class="tab-intro">
        This page gives a high-level snapshot of the trial. The full faba beans trial
        dataset is loaded automatically from <code>faba_beans_trial_clean_named.tsv</code>.
        Every result is calculated directly from those measured plots, with the control
        treatment used as the baseline.
      </p>

      <div class="grid two-column">
        <section class="card">
          <h2>Trial snapshot</h2>
          <div id="overviewSummary" class="overview-summary">
            <!-- Filled by app.js -->
          </div>
        </section>

        <section class="card">
          <h2>How to use this tool</h2>
          <ol class="steps-list">
            <li>
              Go to <strong>Data and settings</strong> to review the commodity price,
              discount rate, and years over which costs and benefits are counted.
            </li>
            <li>
              Go to <strong>Results</strong> to see a clear comparison of each treatment
              against the control, including profits, costs, and ranking.
            </li>
            <li>
              Use the <strong>Charts</strong> tab to see profit and cost patterns
              visually, including where gains come from higher yield or lower costs.
            </li>
            <li>
              Use <strong>Exports and AI brief</strong> to download data and results,
              or to copy a plain-language summary prompt for report writing.
            </li>
          </ol>
        </section>
      </div>
    </section>

    <!-- DATA TAB -->
    <section id="dataTab" class="tab-panel">
      <p class="tab-intro">
        This page controls the main economic assumptions and data source. By default,
        the tool loads the full faba beans trial dataset. You can override this by
        uploading a file or pasting data. All datasets go through the same checks and
        processing, and no rows are removed.
      </p>

      <div class="grid two-column">
        <section class="card">
          <h2>Scenario settings</h2>
          <div class="field-group">
            <label for="pricePerTonne">
              Grain price per tonne
              <span class="help" data-tooltip="Average price received per tonne of harvested faba beans. This multiplies the yield to calculate benefits.">?</span>
            </label>
            <div class="input-with-unit">
              <input id="pricePerTonne" type="number" min="0" step="1" value="500" />
              <span class="unit-label">$/t</span>
            </div>
          </div>

          <div class="field-group">
            <label for="years">
              Years of benefits and costs
              <span class="help" data-tooltip="Number of years over which the treatment is expected to affect yield and costs. This sets the time horizon for the cost–benefit analysis.">?</span>
            </label>
            <input id="years" type="number" min="1" max="40" step="1" value="10" />
          </div>

          <div class="field-group">
            <label for="persistenceYears">
              Years that yield gains last
              <span class="help" data-tooltip="Number of years that yield gains from the soil treatment are expected to last. Costs are counted over the full horizon; yield gains can fade sooner.">?</span>
            </label>
            <input id="persistenceYears" type="number" min="1" max="40" step="1" value="10" />
          </div>

          <div class="field-group">
            <label for="discountRate">
              Discount rate per year
              <span class="help" data-tooltip="Discount rate used to convert future costs and benefits into today’s dollars. Higher rates give less weight to future years.">?</span>
            </label>
            <div class="input-with-unit">
              <input id="discountRate" type="number" min="0" max="30" step="0.5" value="5" />
              <span class="unit-label">%</span>
            </div>
          </div>

          <div class="field-group">
            <label for="controlChoice">
              Control treatment
              <span class="help" data-tooltip="Treatment used as the baseline for all comparisons. By default, this is detected from the trial dataset using the control flag.">?</span>
            </label>
            <select id="controlChoice"></select>
          </div>

          <button id="applyScenario" class="btn primary">Apply settings</button>
        </section>

        <section class="card">
          <h2>Data source</h2>
          <p class="small">
            The tool always starts from the full trial dataset
            <code>faba_beans_trial_clean_named.tsv</code>. You can upload or paste
            another dataset with the same structure. All columns and rows are kept;
            missing values are handled transparently and never filled silently.
          </p>

          <div class="field-group">
            <label>
              Upload trial file
              <span class="help" data-tooltip="Upload a tab-separated or comma-separated file. All columns are read. The file must contain the same types of columns as the original trial.">?</span>
            </label>
            <input id="fileInput" type="file" accept=".tsv,.csv,.txt" />
          </div>

          <div class="field-group">
            <label for="pasteInput">
              Paste data (tab- or comma-separated)
              <span class="help" data-tooltip="Paste the full header row and all data rows from a spreadsheet. The tool will detect whether it is tab- or comma-separated.">?</span>
            </label>
            <textarea id="pasteInput" rows="6" placeholder="Paste header and rows here"></textarea>
            <button id="btnLoadPasted" class="btn secondary">Load pasted data</button>
          </div>

          <div class="field-group inline-actions">
            <button id="btnReloadDefault" class="btn ghost">
              Reload original trial data
            </button>
          </div>

          <div class="data-summary">
            <h3>Dataset summary</h3>
            <div id="dataSummary" class="small muted">
              Waiting for dataset...
            </div>
          </div>

          <div class="data-checks">
            <h3>Data checks</h3>
            <p class="small">
              This section lists any issues found in the dataset, such as missing
              columns or missing values. These checks never remove rows or columns.
            </p>
            <ul id="dataChecks" class="check-list"></ul>
          </div>
        </section>
      </div>
    </section>

    <!-- RESULTS TAB -->
    <section id="resultsTab" class="tab-panel">
      <p class="tab-intro">
        This page shows the main results. Every number is calculated from the full trial
        dataset. The control treatment appears as the baseline. All other treatments
        are compared directly with this control in terms of discounted benefits,
        discounted costs, and net profit per hectare over time.
      </p>

      <section class="card">
        <div class="card-header-row">
          <h2>Treatment leaderboard</h2>
          <div class="field-group compact">
            <label for="leaderboardFilter">
              Filter
              <span class="help" data-tooltip="Use these quick filters to focus on the most profitable or cost-effective treatments compared with the control.">?</span>
            </label>
            <select id="leaderboardFilter">
              <option value="all">Show all treatments</option>
              <option value="topNPV">Top 5 by net profit</option>
              <option value="topBCR">Top 5 by benefit per dollar spent</option>
              <option value="betterThanControl">Only improvements vs control</option>
            </select>
          </div>
        </div>
        <div id="leaderboardContainer" class="leaderboard">
          <!-- Filled by app.js -->
        </div>
      </section>

      <section class="card">
        <div class="card-header-row">
          <h2>Comparison to control</h2>
          <p class="small muted">
            Rows show what is being measured. Columns show the control and each
            treatment. Within each treatment cell you see the level for that treatment
            and the change compared with the control. All figures are per hectare and
            discounted over the years you selected.
          </p>
        </div>

        <div class="comparison-wrapper">
          <table id="comparisonTable" class="comparison-table" aria-describedby="comparisonHelp">
            <!-- Filled by app.js -->
          </table>
        </div>
        <p id="comparisonHelp" class="small muted">
          Net profit over time is the discounted value of total benefits minus discounted
          total costs. Benefit per dollar spent is the ratio of discounted benefits to
          discounted costs. Return on investment is net profit divided by discounted
          costs, expressed as a percentage.
        </p>
      </section>
    </section>

    <!-- CHARTS TAB -->
    <section id="chartsTab" class="tab-panel">
      <p class="tab-intro">
        This page presents charts based on the full dataset. The charts highlight which
        treatments perform better or worse than the control and whether gains come from
        higher yields, lower costs, or both. All charts update when scenario settings
        or data sources change.
      </p>

      <div class="grid two-column">
        <section class="card">
          <h2>Extra net profit compared with control</h2>
          <p class="small muted">
            This bar chart shows the difference in discounted net profit per hectare
            between each treatment and the control. Bars above zero represent gains
            relative to the control; bars below zero represent losses.
          </p>
          <div class="chart-container">
            <canvas id="chartNetProfitVsControl" aria-label="Net profit difference compared with control"></canvas>
          </div>
        </section>

        <section class="card">
          <h2>Total discounted costs and benefits</h2>
          <p class="small muted">
            This chart compares discounted total benefits and discounted total costs per
            hectare for each treatment, including the control. It shows whether a
            treatment wins mainly through higher benefits, lower costs, or a mix of both.
          </p>
          <div class="chart-container">
            <canvas id="chartCostsBenefits" aria-label="Total discounted benefits and costs"></canvas>
          </div>
        </section>
      </div>
    </section>

    <!-- EXPORTS TAB -->
    <section id="exportsTab" class="tab-panel">
      <p class="tab-intro">
        This page lets you take results out of the tool. You can download the cleaned
        dataset, treatment summaries, and results tables for use in spreadsheets or
        reports. You can also copy a ready-made plain-language prompt to use with an
        AI writing assistant.
      </p>

      <div class="grid two-column">
        <section class="card">
          <h2>Download data and results</h2>
          <div class="field-group">
            <button id="btnExportCleanData" class="btn secondary full-width">
              Download cleaned dataset (TSV)
            </button>
            <p class="small muted">
              Contains all columns and rows from the current dataset. No observations
              are removed; missing values are kept explicit.
            </p>
          </div>

          <div class="field-group">
            <button id="btnExportSummary" class="btn secondary full-width">
              Download treatment summary (CSV)
            </button>
            <p class="small muted">
              Contains one row per treatment with average yield, average costs, and all
              discounted cost–benefit indicators.
            </p>
          </div>

          <div class="field-group">
            <button id="btnExportResults" class="btn secondary full-width">
              Download comparison to control (CSV)
            </button>
            <p class="small muted">
              Contains the same indicators as the comparison table, ready to paste into
              a spreadsheet or document.
            </p>
          </div>

          <div class="field-group">
            <button id="btnExportWorkbook" class="btn ghost full-width">
              Download Excel workbook
            </button>
            <p class="small muted">
              Creates an Excel file with sheets for the cleaned dataset, treatment
              summary, and comparison-to-control results.
            </p>
          </div>
        </section>

        <section class="card">
          <h2>AI-ready summary prompt</h2>
          <p class="small muted">
            This prompt describes the scenario, the control, and how each treatment
            compares in terms of benefits, costs, and net profit. You can copy and
            paste it into an AI writing assistant to draft short reports for farmers,
            advisers, or policy makers.
          </p>

          <div class="field-group">
            <label for="aiBriefing">
              Summary prompt text
              <span class="help" data-tooltip="This text is generated from the current scenario and results. You can paste it into any AI assistant to request a report, leaving out or editing any parts you do not need.">?</span>
            </label>
            <textarea id="aiBriefing" rows="10" readonly></textarea>
          </div>
          <button id="btnCopyAiBriefing" class="btn primary">
            Copy summary prompt
          </button>
        </section>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <p class="small muted">
      Developed using the full faba beans trial dataset. All values are illustrative
      of those trials only and should be interpreted with local agronomic advice.
    </p>
  </footer>
</body>
</html>
